<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitAI PWA Debug</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            background: white;
            color: black;
        }
        .debug-info {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .warning { background: #fff3e0; color: #ef6c00; }
        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            margin: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>FitAI PWA Debug Console</h1>
    <div id="debug-output"></div>
    
    <h2>Actions</h2>
    <button onclick="testAuth()">Test Authentication</button>
    <button onclick="clearStorage()">Clear All Storage</button>
    <button onclick="reloadApp()">Reload App</button>
    <button onclick="goToAuth()">Go to Auth</button>
    <button onclick="goToDashboard()">Go to Dashboard</button>

    <script>
        const output = document.getElementById('debug-output');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `debug-info ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            output.appendChild(div);
            console.log(`FitAI PWA Debug: ${message}`);
        }

        // Initial diagnostics
        function runDiagnostics() {
            log('Starting PWA diagnostics...', 'info');
            
            // Check PWA mode
            const isStandalone = window.navigator.standalone === true;
            const isDisplayStandalone = window.matchMedia('(display-mode: standalone)').matches;
            log(`iOS PWA Mode: ${isStandalone}`, isStandalone ? 'success' : 'warning');
            log(`Display Mode: ${isDisplayStandalone ? 'standalone' : 'browser'}`, isDisplayStandalone ? 'success' : 'warning');
            
            // Check current location
            log(`Current URL: ${window.location.href}`, 'info');
            log(`Current Path: ${window.location.pathname}`, 'info');
            
            // Check localStorage
            const cachedAuth = localStorage.getItem('fitai-auth-cache');
            log(`Cached Auth: ${cachedAuth ? 'Present' : 'None'}`, cachedAuth ? 'success' : 'warning');
            
            // Check service worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration().then(registration => {
                    log(`Service Worker: ${registration ? 'Registered' : 'Not registered'}`, registration ? 'success' : 'error');
                });
            } else {
                log('Service Worker: Not supported', 'error');
            }
        }

        async function testAuth() {
            log('Testing authentication...', 'info');
            try {
                const response = await fetch('/api/auth/user', {
                    credentials: 'include',
                    headers: {
                        'X-PWA-Debug': 'true'
                    }
                });
                log(`Auth Response: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.json();
                    log(`User: ${data.user?.email || 'Unknown'}`, 'success');
                } else {
                    log('User: Not authenticated', 'warning');
                }
            } catch (error) {
                log(`Auth Error: ${error.message}`, 'error');
            }
        }

        function clearStorage() {
            localStorage.clear();
            sessionStorage.clear();
            log('Storage cleared', 'success');
        }

        function reloadApp() {
            window.location.reload();
        }

        function goToAuth() {
            window.location.href = '/auth';
        }

        function goToDashboard() {
            window.location.href = '/';
        }

        // Run diagnostics on load
        runDiagnostics();
        
        // Auto-refresh diagnostics every 5 seconds
        setInterval(runDiagnostics, 5000);
    </script>
</body>
</html>